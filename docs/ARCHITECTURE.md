# mz4d: ะััะธัะตะบัััะฐ ัะธััะตะผั

> ะะพะบัะผะตะฝั ะพะฟะธััะฒะฐะตั ะฐััะธัะตะบัััั, ะบะปััะตะฒัะต ัะตัะตะฝะธั ะธ ะฟัะธะฝัะธะฟั ะฟัะพะตะบัะฐ.
> ะะฑะฝะพะฒะปัะตััั ัะธะฝััะพะฝะฝะพ ั ะบะพะดะพะผ.

## 1. ะะฑะทะพั

**mz4d** - ะธะณัะฐ ะดะปั ัะตะปะตะณัะฐะผ-ะฑะพัะฐ. ะะพะปัะทะพะฒะฐัะตะปั ัะพะดะธั ะฟะพ ะปะฐะฑะธัะธะฝัั (ะดะฒัะผะตัะฝะพะผั, ััะตัะผะตัะฝะพะผั ะธ ัะตัััะตัะผะตัะฝะพะผั), ะฒัะฟะพะปะฝัะตั
ะทะฐะดะฐะฝะธะต. ะัะพะฑะตะฝะฝะพัััั ะธะณัั ัะฒะปัะตััั ัะพ, ััะพ ะปะฐะฑะธัะธะฝั ะฝะต ะฟะพะบะฐะทัะฒะฐะตััั, ะฟะพะปัะทะพะฒะฐัะตะปั ะตะณะพ ะดะตัะถะธั "ะฒ ะฟะฐะผััะธ"

## 2. ะัะธะฝัััะต ัะตัะตะฝะธั

### ะะพ Connection/Session ะฒ Artemis

ะะพั ะฟะปััั/ะผะธะฝััั:

**ะะฐัะธะฐะฝั 1: ะะดะธะฝ Connection, Session per virtual thread (ะฐะบัะพั)**

```
โ ะะตะณะบะพะฒะตัะฝะพ - Connection ััะถะตะปัะน ะพะฑัะตะบั, Session ะพัะฝะพัะธัะตะปัะฝะพ ะปะตะณะบะธะน
โ ะัะปะธัะฝะพ ะดััะถะธั ั virtual threads - ะบะฐะถะดัะน ะฟะพัะพะบ ัะฒะพะน Session
โ ะขัะฐะฝะทะฐะบัะธะธ (ะตัะปะธ ะฑัะดัั) ะธะทะพะปะธัะพะฒะฐะฝั ะฟะพ Session
โ ะัะถะฝะพ thread-safe ัะฟัะฐะฒะปะตะฝะธะต ัะพะทะดะฐะฝะธะตะผ Sessions
```

**ะะฐัะธะฐะฝั 2: Connection per actor pool**

```
โ ะะพะปะฝะฐั ะธะทะพะปััะธั ะผะตะถะดั ะฟัะปะฐะผะธ
โ Overhead - ะบะฐะถะดัะน Connection ะดะตัะถะธั ัะตัะตะฒัะต ัะตััััั (ะฝะพ ั ัะตะฑั embedded, ัะฐะบ ััะพ ะฝะต ะบัะธัะธัะฝะพ)
โ ะกะปะพะถะฝะตะต lifecycle management
```

**ะะตัะตะฝะธะต** **ะะดะธะฝ Connection ะฝะฐ ะฟัะธะปะพะถะตะฝะธะต, Session per virtual thread**. Embedded Artemis ัะตัะตะท `vm://` - ัะฐะผ ะฝะตั
ัะตะฐะปัะฝะพะน ัะตัะธ, ัะฐะบ ััะพ Connection ัะพะฒัะตะผ ะปะตะณะบะธะน. ะ Session'ะพะฒ ะผะพะถะฝะพ ัะบะพะปัะบะพ ัะณะพะดะฝะพ ะฝะฐัะพะถะฐัั ะฒ ะฒะธัััะฐะปัะฝัั ะฟะพัะพะบะฐั.

```java
// ะัะธ ััะฐััะต
Connection sharedConnection = connectionFactory.createConnection();
sharedConnection.start(); // ะะดะธะฝ ัะฐะท!

// ะ ะบะฐะถะดะพะผ virtual thread (ะฐะบัะพัะต)
Session session = sharedConnection.createSession(false, Session.AUTO_ACKNOWLEDGE);
MessageConsumer consumer = session.createConsumer(queue);
// ัะธัะฐะตะผ ัะพะพะฑัะตะฝะธั...
```

### ะะพ ัะตัะธะฐะปะธะทะฐัะธะธ

**Jackson ะฒะผะตััะพ Gson/Kryo:**

```
โ Records ะธะท ะบะพัะพะฑะบะธ (ั Java 16+)
โ JSON ัะธัะฐะตะผัะน (ะฒ ะพัะปะธัะธะต ะพั Kryo binary)
โ ะะฐัััะฐะธะฒะฐะตะผัะน (null handling, date formats, etc)
โ ะัััััะน
โ ะะพะฟัะปััะฝัะน - ะผะฝะพะณะพ ะดะพะบัะผะตะฝัะฐัะธะธ
```

ะัะธะผะตั:

```java
ObjectMapper mapper = new ObjectMapper().registerModule(new Jdk8Module()).setSerializationInclusion(JsonInclude.Include.NON_NULL); // ะธะปะธ ALWAYS
```

### ะะพ ungraceful shutdown

**Artemis ั persistence ะฒัะดะตัะถะธั ungraceful shutdown!** ะัะธ ัะตััะฐััะต:

1. ะงะธัะฐะตั journal ั ะดะธัะบะฐ
2. ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตั ะฒัะต ะฝะตะฟะพะดัะฒะตัะถะดะตะฝะฝัะต ัะพะพะฑัะตะฝะธั ะฒ ะพัะตัะตะดะธ
3. ะะบัะพัั ะฟะพะดะบะปััะฐััั ะธ ะฟัะพะดะพะปะถะฐั ะพะฑัะฐะฑะพัะบั

ะะดะธะฝััะฒะตะฝะฝะพะต **ะะ**: ัะพะพะฑัะตะฝะธะต ะผะพะถะตั ะพะฑัะฐะฑะพัะฐัััั ะดะฒะฐะถะดั, ะตัะปะธ ะฐะบัะพั ัะฟะฐะป ะผะตะถะดั ะพะฑัะฐะฑะพัะบะพะน ะธ ACK. ะะพััะพะผั ะธ ะฝัะถะฝะฐ
ะธะดะตะผะฟะพัะตะฝัะฝะพััั (ะดะตะดัะฟะปะธะบะฐัะธั ัะตัะตะท traceId - ะบะฐะบ ัะฐะท ะดะปั ััะพะณะพ).

## ะััะธัะตะบัััะฐ ะฟัะพััะพะณะพ ะบะฐัะบะฐัะฐ

```
โโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโ
โ  Telegram   โ         โ   Console    โ
โ   Poller    โ         โ    Reader    โ
โโโโโโโโฌโโโโโโโ         โโโโโโโโฌโโโโโโโโ
       โ                       โ
       โโโโโโโโโฌโโโโโโโโโโโโโโโโ
               โ
        โโโโโโโโโโโโโโโโ
        โ   MVStore    โ โ ัะพััะฐะฝะธะปะธ incoming message
        โ incoming_msg โ
        โโโโโโโโโโโโโโโโ
               โ
               โ (traceId ะฒ Artemis)
        โโโโโโโโโโโโโโโโ
        โtelegram.     โ
        โ incoming     โ โ ะพัะตัะตะดั
        โโโโโโโโฌโโโโโโโโ
               โ
        โโโโโโโโโโโโโโโโ
        โ Incoming     โ โ ะฟัะป ะฐะบัะพัะพะฒ (virtual threads)
        โ Actor Pool   โ
        โโโโโโโโฌโโโโโโโโ
               โ ัะธัะฐะตั ะธะท MVStore, ััะฐะฝััะพัะผะธััะตั
               โ
        โโโโโโโโโโโโโโโโ
        โ   MVStore    โ โ ัะพััะฐะฝะธะปะธ domain message
        โ domain_msg   โ
        โโโโโโโโโโโโโโโโ
               โ
               โ (traceId ะฒ Artemis)
        โโโโโโโโโโโโโโโโ
        โ game.engine  โ โ ะพัะตัะตะดั
        โโโโโโโโฌโโโโโโโโ
               โ
        โโโโโโโโโโโโโโโโ
        โ GameEngine   โ โ ะฟัะป ะฐะบัะพัะพะฒ
        โ Actor Pool   โ โ ััะธัะฐะตั ัะธะผะฒะพะปั ๐
        โโโโโโโโฌโโโโโโโโ
               โ
               โ
        โโโโโโโโโโโโโโโโ
        โ   MVStore    โ โ ัะพััะฐะฝะธะปะธ reply
        โ  reply_msg   โ
        โโโโโโโโโโโโโโโโ
               โ
               โ (traceId ะฒ Artemis)
        โโโโโโโโโโโโโโโโ
        โtelegram.     โ
        โ outgoing     โ โ ะพัะตัะตะดั
        โโโโโโโโฌโโโโโโโโ
               โ
        โโโโโโโโโโโโโโโโ
        โ Outgoing     โ โ ะฟัะป ะฐะบัะพัะพะฒ
        โ Actor Pool   โ โ ะฟะธัะตั ะฒ outbox
        โโโโโโโโฌโโโโโโโโ
               โ
               โ
        โโโโโโโโโโโโโโโโ
        โ   MVStore    โ
        โ   outbox     โ โ ั TTL!
        โโโโโโโโโโโโโโโโ
               โ
               โ (ะพัะดะตะปัะฝัะน ะฟัะพัะตัั)
        โโโโโโโโโโโโโโโโ
        โ  Outbox      โ
        โ  Processor   โ โ ะพัะฟัะฐะฒะบะฐ ะฒ Telegram/Console
        โโโโโโโโโโโโโโโโ
```

## ะะธัะตะบัะพัะธะธ

```
~/.mz4d/
  โโโ logs/           โ logback ะฟะธัะตั ััะดะฐ
  โโโ data/
  โ   โโโ mvstore/    โ game.mv.db
  โ   โโโ artemis/    โ journal/bindings/etc
  โโโ config/
      โโโ application.conf
```

ะััั ะบ `config/application.conf` ะทะฐัะฐัะดะบะพะถะตะฝ

### ะกัััะบัััะฐ ะฟะฐะบะตัะพะฒ

```
io.github.manjago.mz4d/
โโโ cli/               - CLI ะบะพะผะฐะฝะดั
โโโ config/            - ะะพะฝัะธะณััะฐัะธั
โโโ persistence/       - MVStore, ัะตะฟะพะทะธัะพัะธะธ
โ   โโโ MVStoreManager - ัะฐะฑะพัะฐ ั MVStore, ััะฐะฝะทะฐะบัะธะธ
โ   โโโ repository/    - IncomingMessageRepository, etc
โ   โโโ serialization/ - ะกะตัะธะฐะปะธะทะฐัะธั (ะฟะพ ัะฐะบัั - ะฒ json)
โโโ domain/            - ะะพะผะตะฝะฝัะต ะผะพะดะตะปะธ
โ   โโโ message/       - IncomingMessage, DomainMessage, etc
โโโ actor/             - ะะบัะพัั
โ   โโโ incoming/
โ   โโโ engine/
โ   โโโ outgoing/
โโโ messaging/         - Artemis, ะพัะตัะตะดะธ
โโโ exceptions/        - ะธัะบะปััะตะฝะธั
โโโ Mz4dEngine         - ะะปะฐะฒะฝัะน ะดะฒะธะถะพะบ
```

### ะะปััะตะฒัะต ะบะปะฐััั

#### config (ะบะพะฝัะธะณััะฐัะธั)

| ะะปะฐัั        | ะัะฒะตัััะฒะตะฝะฝะพััั                                |
|--------------|------------------------------------------------|
| `Mz4dConfig` | ะะพะฝัะธะณััะฐัะธั (HOCON, ะผะพะถะฝะพ ะดะพะฟะพะปะฝะธัั ะธะท ัะฐะนะปะฐ) |

#### cli (ะบะพะผะฐะฝะดะฝะฐั ัััะพะบะฐ)

| ะะปะฐัั     | ะัะฒะตัััะฒะตะฝะฝะพััั               |
|-----------|-------------------------------|
| `MazeCli` | ะะปะฐะฒะฝะฐั ัะพัะบะฐ ะฒัะพะดะฐ (picocli) |

#### persistence (ัะตะฐะปะธะทะฐัะธั ัะพััะฐะฝะตะฝะธั ะฝะฐ MvStore)

| ะะปะฐัั            | ะัะฒะตัััะฒะตะฝะฝะพััั   |
|------------------|-------------------|
| `MvStoreManager` | ะฅัะฐะฝะธัะตะปั MVStore |

#### domain.message (ะดะฐะฝะฝัะต ะดะพะผะตะฝะฐ)

| ะะปะฐัั             | ะัะฒะตัััะฒะตะฝะฝะพััั                                   |
|-------------------|---------------------------------------------------|
| `ReceivedMessage` | ะะพะปััะตะฝะพ ะพั ะฒะฝะตัะฝะตะณะพ ะธััะพัะฝะธะบะฐ (Telegram/Console) |
| `GameCommand`     | ะะพะผะฐะฝะดะฐ ะดะปั ะธะณัะพะฒะพะณะพ ะดะฒะธะถะบะฐ                       |
| `GameResponse`    | ะัะฒะตั ะพั ะธะณัะพะฒะพะณะพ ะดะฒะธะถะบะฐ                          |
| `OutgoingMessage` | ะณะพัะพะฒะพ ะบ ะพัะฟัะฐะฒะบะต ะฝะฐััะถั                          |

#### persistence.repository (ัะพััะฐะฝะตะฝะธะต)

| ะะปะฐัั                       | ะัะฒะตัััะฒะตะฝะฝะพััั              |
|-----------------------------|------------------------------|
| `ReceivedMessageRepository` | ะกะพััะฐะฝะตะฝะธะต `ReceivedMessage` |

#### exceptions (ะธัะบะปััะตะฝะธั)

| ะะปะฐัั                | ะัะฒะตัััะฒะตะฝะฝะพััั                                  |
|----------------------|--------------------------------------------------|
| `Mz4dPanicException` | ะัะบะปััะตะฝะธะต, ะฟัะธ ะบะพัะพัะพะผ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฒัะฟะพะปะฝะตะฝะธะต |

#### ะัะฝะพะฒะฝะพะน ะดะฒะธะถะพะบ

| ะะปะฐัั        | ะัะฒะตัััะฒะตะฝะฝะพััั |
|--------------|-----------------|
| `Mz4dEngine` | ะัะฝะพะฒะฝะพะน ะดะฒะธะถะพะบ |

## ะะปะฐะฝ

**ะจะฐะณ 1: MVStore wrapper** (ะฑะตะท Artemis ะฟะพะบะฐ)

- [x] ะะปะฐัั `MvStoreManager` - ะพัะบััะฒะฐะตั/ะทะฐะบััะฒะฐะตั store
- [ ] ะะตะฟะพะทะธัะพัะธะธ: `IncomingMessageRepository`, `DomainMessageRepository`, etc
- [x] ะกะตัะธะฐะปะธะทะฐัะธั ัะตัะตะท Jackson
- [x] ะัะพััะพะน ัะตัั: ัะพััะฐะฝะธะปะธ/ะดะพััะฐะปะธ ัะพะพะฑัะตะฝะธะต

**ะจะฐะณ 2: Artemis bootstrap** (ะฑะตะท ะฐะบัะพัะพะฒ ะฟะพะบะฐ)

- [ ] ะะพะฝัะธะณััะฐัะธั: 3 ะพัะตัะตะดะธ
- [ ] Persistence ะฒ ะดะธัะตะบัะพัะธั
- [ ] ะัะพััะพะน ัะตัั: ะฟะพะปะพะถะธะปะธ ะฒ ะพัะตัะตะดั - ะดะพััะฐะปะธ

**ะจะฐะณ 3: ะะดะธะฝ ะฐะบัะพั** (ะฝะฐะฟัะธะผะตั, IncomingActor)

- [ ] Virtual thread ัะธัะฐะตั ะธะท ะพัะตัะตะดะธ
- [ ] ะะพััะฐะตั ะธะท MVStore
- [ ] ะะปะฐะดะตั ะฒ ัะปะตะดััััั ะพัะตัะตะดั
- [ ] ะะพะณะธััะตั traceId

**ะจะฐะณ 4: Console interface**

- [ ] ะงะธัะฐะตะผ stdin
- [ ] ะะปะฐะดะตะผ ะฒ MVStore + Artemis
- [ ] ะะดะตะผ ะพัะฒะตัะฐ ะธะท outbox
- [ ] ะัะฒะพะดะธะผ ะฒ stdout

**ะจะฐะณ 5: ะะพะปะฝะฐั ัะตะฟะพัะบะฐ**

- [ ] ะัะต ะฐะบัะพัั
- [ ] End-to-end ัะตัั: ะฒะฒะตะปะธ "Hello" โ ะฟะพะปััะธะปะธ "5 symbols"

**ะจะฐะณ 6: Telegram interface**

- [ ] Long polling
- [ ] ะะพะดะบะปััะฐะตะผ ะบ ัััะตััะฒัััะตะน ัะตะฟะพัะบะต
